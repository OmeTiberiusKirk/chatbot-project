import re
import cv2


THAI_MARKS = "่้๊๋ิีึืุูั็์ํเาะโไแใำ"
WORDS = [
    ("บารุง", "บำรุง"),
    ("ศึกษำ", "ศึกษา"),
    ("เอกสำร", "เอกสาร"),
    ("สัญญำ", "สัญญา"),
    ("งำน", "งาน"),
    ("ข่ำว", "ข่าว"),
    ("อย่ำง", "อย่าง"),
    ("บำท", "บาท"),
    ("อนุญำต", "อนุญาต"),
    ("ควำม", "ความ"),
    ("ชั่วครำว", "ชั่วคราว"),
    ("รักษำ", "รักษา"),
    ("พยำบำล", "พยาบาล"),
    ("วิเครำะห์", "วิเคราะห์"),
    ("เวลำ", "เวลา"),
    ("ถัดจำก", "ถัดจาก"),
    ("บริกำร", "บริการ"),
    ("ตำม", "ตาม"),
    ("รำชกำร", "ราชการ"),
    ("เหมำะสม", "เหมาะสม"),
    ("บริหำร", "บริหาร"),
    ("จัดกำร", "จัดการ"),
    ("บัญชีกลำง", "บัญชีกลาง"),
    ("(คมนำคม)|(คมำคม)", "คมนาคม"),
    ("สำมำรถ", "สามารถ"),
    ("กำรมอบหมำย", "การมอบหมาย"),
    ("ภำรกิจ", "ภารกิจ"),
    ("สำรบรรณ", "สารบรรณ"),
    ("รำคำ", "ราคา"),
    ("กำรประชำสัมพันธ์", "การประชาสัมพันธ์"),
    ("ประกำศ", "ประกาศ"),
    ("กำรบูรณำกำร", "การบูรณาการ"),
    ("พิจำรณำจำก", "พิจารณาจาก"),
    ("ฮำร์ดแวร์", "ฮาร์ดแวร์"),
    ("อัตรำ", "อัตรา"),
    ("ฐำนข้อมูล", "ฐานข้อมูล"),
    ("วิทยำกำร", "วิทยาการ"),
    ("สำขำ", "สาขา"),
    ("ประสบกำรณ์", "ประสบการณ์"),
    ("กำรต่อต้ำน", "การต่อต้าน"),
    ("กำรทุจริต", "การทุจริต"),
    ("กำรบำรุง", "การบำรุง"),
    ("แจ้งจำก", "แจ้งจาก"),
    ("ชำนำญกำร", "ชำนาญการ"),
    ("ปฏิบัติกำร", "ปฏิบัติการ"),
    ("ภำยใน", "ภายใน"),
    ("ค่ำบริการ", "ค่าบริการ"),
    ("จ้ำง", "จ้าง"),
    ("ปัญหำ", "ปัญหา"),
    ("ภำษำ", "ภาษา"),
    ("จานวน", "จำนวน"),
    ("นามา", "นำมา"),
    ("ชาระ", "ชำระ"),
    ("กำรทำงาน", "การทำงาน"),
    ("กำรพัฒนำ", "การพัฒนา"),
    ("สำรสนเทศ", "สารสนเทศ"),
    ("ทิงงาน", "ทิ้งงาน"),
    ("ถ่ำย", "ถ่าย"),
    ("วิชำกำร", "วิชาการ"),
    ("ธนำคำร", "ธนาคาร"),
]


def clean_thai_text(text: str) -> str:
    text = text.replace("\u00a0", " ").replace("\u200b", "")
    text = re.sub(rf"([ก-ฮ])\s+([{THAI_MARKS}])", r"\1\2", text)
    text = re.sub(rf"([{THAI_MARKS}])\s+([ก-ฮ])", r"\1\2", text)
    text = re.sub(rf"([{THAI_MARKS}])\s+([{THAI_MARKS}])", r"\1\2", text)
    # text = re.sub(r"\s{2,}", " ", text)
    # text = re.sub(r"\n", "", text)
    for word in WORDS:
        text = re.sub(rf"{word[0]}", word[1], text)
    return text.strip()


def thai_sentence_split(text: str):
    # แบ่งโดยใช้ newline และ punctuation ไทย/สากล เป็นหลัก
    # (ไม่ใช้ tokenizer ชั้นสูงเพื่อหลีกเลี่ยง dependency)
    pieces = re.split(r"([\n]+|[।\.\?\!])+", text)
    # รวมชิ้นที่เป็นเนื้อหา
    out = []
    buffer = ""
    for p in pieces:
        if not p:
            continue
        buffer += p
        # ถ้าจบด้วยเครื่องหมายจบประโยคหรือ newline ให้เป็นประโยค
        if re.search(r"[।\.\?\!]\s*$", p) or "\n" in p:
            s = buffer.strip()
            if s:
                out.append(s)
            buffer = ""
    if buffer.strip():
        out.append(buffer.strip())
    return out


def crop_content_only(cv_img):
    # 1. กลับสีภาพ (ให้พื้นหลังเป็นดำ ตัวอักษรเป็นขาว เพื่อหาขอบเขต)
    inverted = cv2.bitwise_not(cv_img)

    # 2. หาจุดที่มีสีขาว (ซึ่งก็คือตัวหนังสือ)
    points = cv2.findNonZero(inverted)

    # 3. สร้างสี่เหลี่ยมล้อมรอบจุดทั้งหมด
    x, y, w, h = cv2.boundingRect(points)

    # 4. Crop โดยเผื่อขอบ (Padding) ไว้สัก 20-40 pixels ไม่ให้ชิดเกินไป
    padding = 30
    crop = cv_img[
        max(0, y - padding) : min(cv_img.shape[0], y + h + padding),
        max(0, x - padding) : min(cv_img.shape[1], x + w + padding),
    ]

    return crop
